<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - Smart Dobi</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-wrapper">
        <div class="login-card">
            <div class="login-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
            </div>
            <h1>Dashboard Pemilik</h1>
            <p>Log masuk untuk mengurus mesin</p>
            
            <button id="googleLoginBtn" class="btn-google" onclick="signInWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Log Masuk dengan Google
            </button>
            
            <a href="index.html" class="back-link">‚Üê Kembali ke Kiosk</a>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="dashboard-container" style="display: none;">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-info">
                <h1>üß∫ Smart Dobi</h1>
                <p>Dashboard Pemilik</p>
            </div>
            <div class="header-actions">
                <img id="userPhoto" src="" alt="" class="user-avatar">
                <button class="btn-logout" onclick="signOut()">Log Keluar</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card success">
                <div class="stat-value" id="statAvailable">0</div>
                <div class="stat-label">Tersedia</div>
            </div>
            <div class="stat-card primary">
                <div class="stat-value" id="statWashing">0</div>
                <div class="stat-label">Beroperasi</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-value" id="statCycles">0</div>
                <div class="stat-label">Kitaran Hari Ini</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-value" id="statRevenue">RM 0</div>
                <div class="stat-label">Hasil Hari Ini</div>
            </div>
        </div>

        <!-- Machines Management -->
        <h2 class="section-title">‚öôÔ∏è Kawalan Mesin</h2>
        <div id="machinesManagement" class="machines-management">
            <div class="loading-container">
                <div class="spinner"></div>
                <p class="text-muted">Memuatkan...</p>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-overlay" style="display: none;">
        <div class="modal-card">
            <h2>Edit Mesin <span id="editMachineId">1</span></h2>
            
            <div class="status-options">
                <button class="status-option" data-status="available" onclick="selectStatus('available')">
                    <div class="icon available">‚úÖ</div>
                    <span class="text">Tersedia</span>
                </button>
                <button class="status-option" data-status="broken" onclick="selectStatus('broken')">
                    <div class="icon broken">üîß</div>
                    <span class="text">Rosak / Maintenance</span>
                </button>
            </div>
            
            <button class="btn-save" onclick="saveStatus()">üíæ Simpan</button>
            <button class="btn-cancel" onclick="closeEditModal()">Batal</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, update, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut as firebaseSignOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBPaObgmHZBQR8-0aX3pTUOFeMOxIsn0Lc",
            authDomain: "smart-dobi-system-fyp.firebaseapp.com",
            databaseURL: "https://smart-dobi-system-fyp-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smart-dobi-system-fyp",
            storageBucket: "smart-dobi-system-fyp.firebasestorage.app",
            messagingSenderId: "377544234994",
            appId: "1:377544234994:web:690cd32c142e7ee501fd6b"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let selectedMachineId = null;
        let selectedStatus = null;

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showDashboard();
            } else {
                currentUser = null;
                showLogin();
            }
        });

        // Sign in
        window.signInWithGoogle = function() {
            signInWithPopup(auth, provider).catch((error) => {
                console.error('Login error:', error);
                alert('Ralat log masuk');
            });
        }

        // Sign out
        window.signOut = function() {
            firebaseSignOut(auth);
        }

        function showLogin() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('dashboardSection').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            
            if (currentUser) {
                document.getElementById('userPhoto').src = currentUser.photoURL || '';
            }
            
            loadMachines();
            loadDailyStats();
        }

        // Format time
        function formatTime(seconds) {
            if (!seconds || seconds <= 0) return '--:--';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Get status text
        function getStatusText(status) {
            const map = {
                'available': 'Tersedia',
                'washing': 'Sedang Basuh',
                'reserved': 'Ditempah',
                'broken': 'Rosak'
            };
            return map[status] || status;
        }

        // Create management card
        function createManagementCard(id, data) {
            const status = data.status || 'available';
            const isOnline = data.is_online !== false;
            const isReal = data.is_real === true;
            const timeRemaining = data.time_remaining || 0;
            const whatsapp = data.whatsapp || '-';

            const icons = { 'available': '‚úÖ', 'washing': 'üîÑ', 'reserved': '‚è≥', 'broken': 'üîß' };

            return `
                <div class="management-card">
                    <div class="management-card-header">
                        <div class="machine-badge">
                            <div class="badge-icon ${status}">${icons[status] || 'üß∫'}</div>
                            <div class="badge-text">
                                <h3>Mesin ${id}</h3>
                                <p class="${isReal ? 'real' : 'dummy'}">${isReal ? 'üîå Real ESP32' : 'üì± Demo Only'}</p>
                            </div>
                        </div>
                        <div class="online-status ${isOnline ? 'online' : 'offline'}">
                            <span class="online-dot"></span>
                            ${isOnline ? 'Online' : 'Offline'}
                        </div>
                    </div>
                    
                    <div class="management-card-body">
                        <div class="info-item">
                            <span class="label">Status</span>
                            <span class="status-tag ${status}">${getStatusText(status)}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Timer</span>
                            <span class="value">${status === 'washing' ? formatTime(timeRemaining) : '-'}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">WhatsApp</span>
                            <span class="value">${whatsapp}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">Jenis</span>
                            <span class="value">${isReal ? 'Real' : 'Demo'}</span>
                        </div>
                    </div>
                    
                    <div class="management-card-actions">
                        <button class="btn-edit" onclick="openEditModal('${id}')">
                            ‚úèÔ∏è Edit Status
                        </button>
                        <button class="btn-reset" onclick="resetMachine('${id}')">
                            üîÑ Reset
                        </button>
                    </div>
                </div>`;
        }

        // Load machines
        function loadMachines() {
            const container = document.getElementById('machinesManagement');
            const machinesRef = ref(database, 'machines');

            onValue(machinesRef, (snapshot) => {
                const machines = snapshot.val();
                
                if (!machines) {
                    container.innerHTML = '<p class="text-muted">Tiada mesin</p>';
                    return;
                }

                container.innerHTML = '';
                let available = 0, washing = 0;

                const sortedIds = Object.keys(machines).sort((a, b) => parseInt(a) - parseInt(b));
                
                sortedIds.forEach(id => {
                    container.innerHTML += createManagementCard(id, machines[id]);
                    if (machines[id].status === 'available') available++;
                    if (machines[id].status === 'washing') washing++;
                });

                document.getElementById('statAvailable').textContent = available;
                document.getElementById('statWashing').textContent = washing;
            });
        }

        // Load daily stats
        function loadDailyStats() {
            const today = new Date().toISOString().split('T')[0];
            const statsRef = ref(database, `daily_records/${today}`);

            onValue(statsRef, (snapshot) => {
                const data = snapshot.val() || { cycles: 0, revenue: 0 };
                document.getElementById('statCycles').textContent = data.cycles || 0;
                document.getElementById('statRevenue').textContent = `RM ${data.revenue || 0}`;
            });
        }

        // Open edit modal
        window.openEditModal = function(id) {
            selectedMachineId = id;
            selectedStatus = null;
            document.getElementById('editMachineId').textContent = id;
            document.querySelectorAll('.status-option').forEach(el => el.classList.remove('selected'));
            document.getElementById('editModal').style.display = 'flex';
        }

        // Close edit modal
        window.closeEditModal = function() {
            document.getElementById('editModal').style.display = 'none';
            selectedMachineId = null;
            selectedStatus = null;
        }

        // Select status
        window.selectStatus = function(status) {
            selectedStatus = status;
            document.querySelectorAll('.status-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.status === status);
            });
        }

        // Save status
        window.saveStatus = async function() {
            if (!selectedMachineId || !selectedStatus) {
                alert('Sila pilih status');
                return;
            }

            try {
                const machineRef = ref(database, `machines/${selectedMachineId}`);
                await update(machineRef, {
                    status: selectedStatus,
                    whatsapp: null,
                    time_remaining: 0
                });
                closeEditModal();
            } catch (error) {
                console.error('Error:', error);
                alert('Ralat menyimpan');
            }
        }

        // Reset machine
        window.resetMachine = async function(id) {
            if (!confirm(`Reset Mesin ${id} ke status Tersedia?`)) return;

            try {
                const machineRef = ref(database, `machines/${id}`);
                await update(machineRef, {
                    status: 'available',
                    whatsapp: null,
                    time_remaining: 0
                });
            } catch (error) {
                console.error('Error:', error);
                alert('Ralat reset');
            }
        }
    </script>
</body>
</html>
