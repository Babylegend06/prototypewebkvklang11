/*
 * Smart Dobi ESP32 S3 Firmware
 * Hardware: 1 Button + 1 Relay + 1 LED per machine (2 machines)
 * 
 * Features:
 * - 30 minit wash cycle (1800 seconds)
 * - WhatsApp notifications via WasapBot.my
 * - LED mati bila mesin siap
 * - Button untuk manual control (optional)
 */

#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>

// WiFi Credentials
const char* WIFI_SSID = \"YOUR_WIFI_SSID\";\nconst char* WIFI_PASSWORD = \"YOUR_WIFI_PASSWORD\";\n\n// Backend API Configuration\nconst char* BACKEND_URL = \"YOUR_BACKEND_URL\";  // Example: https://dobi-alert.preview.emergentagent.com\nconst char* API_BASE = \"/api\";\n\n// WasapBot.my Configuration\nconst char* WASAPBOT_URL = \"https://dash.wasapbot.my/whatsapp_api\";\nconst char* WASAPBOT_INSTANCE_ID = \"YOUR_INSTANCE_ID\";\nconst char* WASAPBOT_ACCESS_TOKEN = \"YOUR_ACCESS_TOKEN\";\n\n// Pin Configuration for Machine 1\nconst int BUTTON_1 = 16;   // Button untuk Machine 1\nconst int RELAY_1 = 18;    // Relay untuk Machine 1\nconst int LED_1 = 19;      // LED untuk Machine 1\n\n// Pin Configuration for Machine 2\nconst int BUTTON_2 = 17;   // Button untuk Machine 2\nconst int RELAY_2 = 21;    // Relay untuk Machine 2\nconst int LED_2 = 22;      // LED untuk Machine 2\n\n// Machine States\nstruct MachineState {\n  String machineId;\n  String status;\n  String whatsappNumber;\n  int timeRemaining;\n  int buttonPin;\n  int relayPin;\n  int ledPin;\n  bool isRunning;\n  unsigned long startTime;\n  bool reminderSent;\n  bool lastButtonState;\n};\n\nMachineState machine1 = {\"1\", \"available\", \"\", 0, BUTTON_1, RELAY_1, LED_1, false, 0, false, HIGH};\nMachineState machine2 = {\"2\", \"available\", \"\", 0, BUTTON_2, RELAY_2, LED_2, false, 0, false, HIGH};\n\nunsigned long lastPollTime = 0;\nconst unsigned long POLL_INTERVAL = 2000; // Poll every 2 seconds\nconst unsigned long CYCLE_TIME = 1800; // 30 minit = 1800 seconds\nconst unsigned long REMINDER_TIME = 1500; // Reminder at 25 min (5 min remaining)\n\nvoid setup() {\n  Serial.begin(115200);\n  Serial.println(\"\\n\\n=== Smart Dobi ESP32 S3 Startup ===\");\n  \n  // Initialize button pins (INPUT_PULLUP)\n  pinMode(BUTTON_1, INPUT_PULLUP);\n  pinMode(BUTTON_2, INPUT_PULLUP);\n  \n  // Initialize relay and LED pins\n  pinMode(RELAY_1, OUTPUT);\n  pinMode(LED_1, OUTPUT);\n  pinMode(RELAY_2, OUTPUT);\n  pinMode(LED_2, OUTPUT);\n  \n  // Set all relays OFF and LEDs OFF initially\n  digitalWrite(RELAY_1, LOW);\n  digitalWrite(RELAY_2, LOW);\n  digitalWrite(LED_1, LOW);\n  digitalWrite(LED_2, LOW);\n  \n  // Connect to WiFi\n  connectToWiFi();\n  \n  Serial.println(\"Smart Dobi Ready!\");\n  Serial.println(\"================================\\n\");\n}\n\nvoid loop() {\n  // Check WiFi connection\n  if (WiFi.status() != WL_CONNECTED) {\n    Serial.println(\"WiFi disconnected. Reconnecting...\");\n    connectToWiFi();\n  }\n  \n  // Poll backend every 2 seconds\n  if (millis() - lastPollTime >= POLL_INTERVAL) {\n    lastPollTime = millis();\n    checkMachineStatus(&machine1);\n    checkMachineStatus(&machine2);\n  }\n  \n  // Check manual buttons\n  checkButton(&machine1);\n  checkButton(&machine2);\n  \n  // Update machine cycles\n  updateMachineCycle(&machine1);\n  updateMachineCycle(&machine2);\n  \n  // Update LED status\n  updateLEDStatus(&machine1);\n  updateLEDStatus(&machine2);\n  \n  delay(100);\n}\n\nvoid connectToWiFi() {\n  Serial.print(\"Connecting to WiFi: \");\n  Serial.println(WIFI_SSID);\n  \n  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);\n  \n  int attempts = 0;\n  while (WiFi.status() != WL_CONNECTED && attempts < 20) {\n    delay(500);\n    Serial.print(\".\");\n    attempts++;\n  }\n  \n  if (WiFi.status() == WL_CONNECTED) {\n    Serial.println(\"\\nWiFi Connected!\");\n    Serial.print(\"IP Address: \");\n    Serial.println(WiFi.localIP());\n  } else {\n    Serial.println(\"\\nWiFi Connection Failed!\");\n  }\n}\n\nvoid checkButton(MachineState* machine) {\n  bool currentButtonState = digitalRead(machine->buttonPin);\n  \n  // Button pressed (LOW because of INPUT_PULLUP)\n  if (currentButtonState == LOW && machine->lastButtonState == HIGH) {\n    delay(50); // Debounce\n    if (digitalRead(machine->buttonPin) == LOW) {\n      Serial.println(\"Button pressed for Machine \" + machine->machineId);\n      \n      if (machine->status == \"available\") {\n        // Start machine manually\n        Serial.println(\"Manual start - Machine \" + machine->machineId);\n        // You can add manual start logic here if needed\n      } else if (machine->status == \"washing\") {\n        Serial.println(\"Machine \" + machine->machineId + \" is already running\");\n      }\n    }\n  }\n  \n  machine->lastButtonState = currentButtonState;\n}\n\nvoid checkMachineStatus(MachineState* machine) {\n  if (WiFi.status() != WL_CONNECTED) return;\n  \n  HTTPClient http;\n  String url = String(BACKEND_URL) + String(API_BASE) + \"/machines/\" + machine->machineId;\n  \n  http.begin(url);\n  int httpCode = http.GET();\n  \n  if (httpCode == 200) {\n    String payload = http.getString();\n    DynamicJsonDocument doc(1024);\n    deserializeJson(doc, payload);\n    \n    String newStatus = doc[\"status\"].as<String>();\n    String newWhatsapp = doc[\"whatsapp_number\"] | \"\";\n    \n    // Detect status change to \"washing\"\n    if (newStatus == \"washing\" && machine->status != \"washing\") {\n      Serial.println(\"Machine \" + machine->machineId + \" - Starting wash cycle!\");\n      machine->status = newStatus;\n      machine->whatsappNumber = newWhatsapp;\n      machine->isRunning = true;\n      machine->startTime = millis();\n      machine->reminderSent = false;\n      machine->timeRemaining = CYCLE_TIME;\n      \n      // Turn ON relay (start machine)\n      digitalWrite(machine->relayPin, HIGH);\n      Serial.println(\"Relay \" + String(machine->relayPin) + \" activated\");\n    } else {\n      machine->status = newStatus;\n    }\n  } else {\n    Serial.println(\"Error polling machine \" + machine->machineId + \": HTTP \" + String(httpCode));\n  }\n  \n  http.end();\n}\n\nvoid updateMachineCycle(MachineState* machine) {\n  if (!machine->isRunning) return;\n  \n  unsigned long elapsedSeconds = (millis() - machine->startTime) / 1000;\n  machine->timeRemaining = CYCLE_TIME - elapsedSeconds;\n  \n  // Send reminder at 25 minutes (5 minutes remaining)\n  if (elapsedSeconds >= REMINDER_TIME && !machine->reminderSent) {\n    machine->reminderSent = true;\n    sendReminderToBackend(machine->machineId);\n    Serial.println(\"Machine \" + machine->machineId + \" - Reminder sent (5 min remaining)\");\n  }\n  \n  // Complete cycle at 30 minutes\n  if (elapsedSeconds >= CYCLE_TIME) {\n    Serial.println(\"Machine \" + machine->machineId + \" - Wash cycle complete!\");\n    \n    // Turn OFF relay (stop machine)\n    digitalWrite(machine->relayPin, LOW);\n    Serial.println(\"Relay \" + String(machine->relayPin) + \" deactivated\");\n    \n    // Turn OFF LED (mesin siap, lampu mati)\n    digitalWrite(machine->ledPin, LOW);\n    Serial.println(\"LED \" + String(machine->ledPin) + \" turned OFF (machine complete)\");\n    \n    // Update backend status to \"available\"\n    updateBackendStatus(machine->machineId, \"available\", 0);\n    \n    // Reset machine state\n    machine->isRunning = false;\n    machine->status = \"available\";\n    machine->whatsappNumber = \"\";\n    machine->timeRemaining = 0;\n    machine->reminderSent = false;\n  }\n}\n\nvoid updateLEDStatus(MachineState* machine) {\n  if (machine->status == \"washing\") {\n    // LED ON bila washing\n    digitalWrite(machine->ledPin, HIGH);\n  } else if (machine->status == \"available\" && !machine->isRunning) {\n    // LED OFF bila available (siap)\n    digitalWrite(machine->ledPin, LOW);\n  }\n}\n\nvoid sendReminderToBackend(String machineId) {\n  if (WiFi.status() != WL_CONNECTED) return;\n  \n  HTTPClient http;\n  String url = String(BACKEND_URL) + String(API_BASE) + \"/machines/\" + machineId + \"/reminder\";\n  \n  http.begin(url);\n  int httpCode = http.POST(\"\");\n  \n  if (httpCode == 200) {\n    Serial.println(\"Reminder sent to backend for Machine \" + machineId);\n  } else {\n    Serial.println(\"Reminder send failed: HTTP \" + String(httpCode));\n  }\n  \n  http.end();\n}\n\nvoid updateBackendStatus(String machineId, String status, int timeRemaining) {\n  if (WiFi.status() != WL_CONNECTED) return;\n  \n  HTTPClient http;\n  String url = String(BACKEND_URL) + String(API_BASE) + \"/machines/\" + machineId + \"/status\" +\n               \"?status=\" + status + \"&time_remaining=\" + String(timeRemaining);\n  \n  http.begin(url);\n  int httpCode = http.sendRequest(\"PUT\");\n  \n  if (httpCode == 200) {\n    Serial.println(\"Backend status updated: Machine \" + machineId + \" -> \" + status);\n  } else {\n    Serial.println(\"Backend update failed: HTTP \" + String(httpCode));\n  }\n  \n  http.end();\n}\n\nString urlEncode(String str) {\n  String encoded = \"\";\n  char c;\n  for (int i = 0; i < str.length(); i++) {\n    c = str.charAt(i);\n    if (c == ' ') {\n      encoded += '+';\n    } else if (isalnum(c)) {\n      encoded += c;\n    } else {\n      encoded += '%';\n      if (c < 16) encoded += '0';\n      encoded += String(c, HEX);\n    }\n  }\n  return encoded;\n}\n\n/*\n * HARDWARE WIRING GUIDE:\n * \n * Machine 1:\n * - GPIO 16 -> Button 1 (with pull-up resistor or use INPUT_PULLUP)\n * - GPIO 18 -> Relay 1 IN\n * - GPIO 19 -> LED 1 (through 220Ω resistor)\n * \n * Machine 2:\n * - GPIO 17 -> Button 2 (with pull-up resistor or use INPUT_PULLUP)\n * - GPIO 21 -> Relay 2 IN\n * - GPIO 22 -> LED 2 (through 220Ω resistor)\n * \n * Power:\n * - ESP32 3.3V/5V -> Relay VCC (check relay voltage)\n * - ESP32 GND -> Common GND for all components\n * \n * CONFIGURATION STEPS:\n * 1. Update WiFi credentials (WIFI_SSID and WIFI_PASSWORD)\n * 2. Update BACKEND_URL dengan URL app anda\n * 3. Update WASAPBOT_INSTANCE_ID dan WASAPBOT_ACCESS_TOKEN\n * 4. Upload to ESP32 S3\n * 5. Open Serial Monitor (115200 baud)\n * \n * CYCLE TIMING:\n * - Total cycle: 30 minit (1800 seconds)\n * - Reminder: 25 minit (5 minit remaining)\n * - LED: ON during wash, OFF when complete\n * \n * WHATSAPP FLOW:\n * 1. Payment done -> \"Mesin start sila tunggu 30 minit\"\n * 2. 25 min elapsed -> \"MESIN X HAMPIR SIAP DALAM 5 MINIT LAGI\"\n * 3. 30 min done -> \"MESIN X SIAP! Sila ambil pakaian anda\"\n */\n