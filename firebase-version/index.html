<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Dobi</title>
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>SMART DOBI</h1>
            <p>Self-Service Laundry</p>
        </header>

        <!-- Machines Grid -->
        <div id="machinesGrid" class="machines-grid">
            <div class="loading-container">
                <div class="spinner"></div>
                <p class="text-muted">Memuatkan mesin...</p>
            </div>
        </div>

        <!-- Owner Login -->
        <div class="owner-login">
            <a href="dashboard.html" class="btn-glass">
                üîê Owner Dashboard
            </a>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboardingModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Selamat Datang! üëã</h2>
                <p>Cara menggunakan Smart Dobi</p>
            </div>

            <div class="onboarding-steps">
                <div class="step-item">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3>Pilih Mesin</h3>
                        <p>Tekan butang PILIH pada mesin yang tersedia</p>
                    </div>
                </div>

                <div class="step-item">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3>Bayar & Masukkan WhatsApp</h3>
                        <p>Scan QR untuk bayar, masukkan no. telefon untuk notifikasi</p>
                    </div>
                </div>

                <div class="step-item">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h3>Tekan START di Mesin</h3>
                        <p>Masukkan baju, tekan butang START pada mesin</p>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary btn-full" onclick="closeOnboarding()">
                Faham! üëç
            </button>
        </div>
    </div>

    <!-- Firebase SDK (Modular v9+) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, set, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBPaObgmHZBQR8-0aX3pTUOFeMOxIsn0Lc",
            authDomain: "smart-dobi-system-fyp.firebaseapp.com",
            databaseURL: "https://smart-dobi-system-fyp-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smart-dobi-system-fyp",
            storageBucket: "smart-dobi-system-fyp.firebasestorage.app",
            messagingSenderId: "377544234994",
            appId: "1:377544234994:web:690cd32c142e7ee501fd6b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const machinesRef = ref(database, 'machines');

        // Check first visit
        function checkFirstVisit() {
            const visited = localStorage.getItem('smartDobi_visited');
            if (!visited) {
                document.getElementById('onboardingModal').style.display = 'flex';
            }
        }

        window.closeOnboarding = function() {
            document.getElementById('onboardingModal').style.display = 'none';
            localStorage.setItem('smartDobi_visited', 'true');
        }

        // Format time MM:SS
        function formatTime(seconds) {
            if (!seconds || seconds <= 0) return '--:--';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Get status text
        function getStatusText(status) {
            const map = {
                'available': 'Tersedia',
                'washing': 'Sedang Basuh',
                'reserved': 'Ditempah',
                'broken': 'Rosak',
                'maintenance': 'Maintenance'
            };
            return map[status] || status;
        }

        // Create machine card
        function createMachineCard(id, data) {
            const status = data.is_online === false ? 'maintenance' : (data.status || 'available');
            const isReal = data.is_real === true;
            const isDummy = !isReal;
            const timeRemaining = data.time_remaining || 0;
            
            const isAvailable = status === 'available';
            const isWashing = status === 'washing';
            
            // Icon emoji
            const icons = {
                'available': '‚úÖ',
                'washing': 'üîÑ',
                'reserved': '‚è≥',
                'broken': 'üîß',
                'maintenance': 'üîß'
            };
            
            // Timer or status display
            let rightContent = '';
            if (isWashing && timeRemaining > 0) {
                rightContent = `
                    <div class="timer-display">
                        <div class="timer-value">${formatTime(timeRemaining)}</div>
                        <div class="timer-label">Berbaki</div>
                    </div>`;
            } else if (isAvailable) {
                rightContent = `<button class="btn-action primary" onclick="selectMachine('${id}')">PILIH</button>`;
            } else {
                rightContent = `<button class="btn-action disabled" disabled>${getStatusText(status)}</button>`;
            }
            
            return `
                <div class="machine-card ${isDummy ? 'dummy' : ''}" style="animation-delay: ${(parseInt(id) - 1) * 0.05}s">
                    <div class="machine-info">
                        <div class="machine-icon ${status}">${icons[status] || 'üß∫'}</div>
                        <div class="machine-details">
                            <h3>Mesin ${id}</h3>
                            <p class="machine-status ${status}">${getStatusText(status)}${isDummy ? ' (Demo)' : ''}</p>
                        </div>
                    </div>
                    ${rightContent}
                </div>`;
        }

        // Select machine
        window.selectMachine = function(id) {
            window.location.href = `payment.html?machine=${id}`;
        }

        // Initialize default machines if empty
        function initMachines(snapshot) {
            if (!snapshot.exists()) {
                const defaults = {
                    "1": { status: "available", is_online: true, is_real: true, whatsapp: null, time_remaining: 0 },
                    "2": { status: "available", is_online: true, is_real: true, whatsapp: null, time_remaining: 0 },
                    "3": { status: "available", is_online: true, is_real: false, whatsapp: null, time_remaining: 0 },
                    "4": { status: "washing", is_online: true, is_real: false, whatsapp: null, time_remaining: 1234 },
                    "5": { status: "broken", is_online: true, is_real: false, whatsapp: null, time_remaining: 0 },
                    "6": { status: "available", is_online: true, is_real: false, whatsapp: null, time_remaining: 0 }
                };
                set(machinesRef, defaults);
            }
        }

        // Load machines
        function loadMachines() {
            const grid = document.getElementById('machinesGrid');
            
            onValue(machinesRef, (snapshot) => {
                initMachines(snapshot);
                const machines = snapshot.val();
                
                if (!machines) {
                    grid.innerHTML = '<div class="loading-container"><p class="text-muted">Tiada mesin</p></div>';
                    return;
                }
                
                grid.innerHTML = '';
                const sortedIds = Object.keys(machines).sort((a, b) => parseInt(a) - parseInt(b));
                
                sortedIds.forEach(id => {
                    grid.innerHTML += createMachineCard(id, machines[id]);
                });
            });
        }

        // Initialize
        checkFirstVisit();
        loadMachines();
    </script>
</body>
</html>
