<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Menunggu - Smart Dobi</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/waiting.css">
</head>
<body>
    <div class="waiting-wrapper">
        <div class="waiting-card">
            <!-- Success Icon -->
            <div class="success-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>

            <h1>Pembayaran Berjaya! ‚úì</h1>
            <p class="subtitle">Mesin <span id="machineNumber">1</span> ditempah untuk anda</p>

            <!-- Real-time Timer from ESP32 -->
            <div class="timer-section">
                <div class="timer-big" id="timerDisplay">--:--</div>
                <div class="timer-status" id="timerStatus">Menunggu anda tekan START...</div>
            </div>

            <!-- Instructions -->
            <div class="instructions-box">
                <h3>üìã Arahan Seterusnya</h3>
                
                <div class="instruction-step">
                    <div class="step-num">1</div>
                    <div class="step-text">Pergi ke <strong>Mesin <span class="machine-num">1</span></strong></div>
                </div>
                
                <div class="instruction-step">
                    <div class="step-num">2</div>
                    <div class="step-text">LED akan <span class="highlight-yellow">berkelip kuning</span></div>
                </div>
                
                <div class="instruction-step">
                    <div class="step-num">3</div>
                    <div class="step-text">Masukkan <strong>pakaian</strong> ke dalam mesin</div>
                </div>
                
                <div class="instruction-step">
                    <div class="step-num">4</div>
                    <div class="step-text">Tekan butang <span class="highlight-green">START</span> pada mesin</div>
                </div>
            </div>

            <!-- Back Button -->
            <a href="index.html" class="btn-back">
                ‚Üê Kembali ke Halaman Utama
            </a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBPaObgmHZBQR8-0aX3pTUOFeMOxIsn0Lc",
            authDomain: "smart-dobi-system-fyp.firebaseapp.com",
            databaseURL: "https://smart-dobi-system-fyp-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smart-dobi-system-fyp",
            storageBucket: "smart-dobi-system-fyp.firebasestorage.app",
            messagingSenderId: "377544234994",
            appId: "1:377544234994:web:690cd32c142e7ee501fd6b"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Get machine ID
        const params = new URLSearchParams(window.location.search);
        const machineId = params.get('machine');

        if (!machineId) {
            window.location.href = 'index.html';
        } else {
            document.getElementById('machineNumber').textContent = machineId;
            document.querySelectorAll('.machine-num').forEach(el => el.textContent = machineId);
        }

        // Format time
        function formatTime(seconds) {
            if (!seconds || seconds <= 0) return '--:--';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Listen to machine status (REAL-TIME TIMER FROM ESP32)
        const machineRef = ref(database, `machines/${machineId}`);
        
        onValue(machineRef, (snapshot) => {
            const machine = snapshot.val();
            if (!machine) return;

            const timerDisplay = document.getElementById('timerDisplay');
            const timerStatus = document.getElementById('timerStatus');
            const timerSection = document.querySelector('.timer-section');

            if (machine.status === 'washing') {
                // ESP32 is updating time_remaining - display it
                const timeRemaining = machine.time_remaining || 0;
                timerDisplay.textContent = formatTime(timeRemaining);
                
                if (timeRemaining <= 300 && timeRemaining > 0) {
                    timerStatus.textContent = '‚ö° Hampir siap!';
                    timerStatus.classList.remove('waiting');
                    timerSection.style.background = 'linear-gradient(135deg, #FF9500 0%, #FF3B30 100%)';
                } else if (timeRemaining > 0) {
                    timerStatus.textContent = 'üîÑ Sedang basuh...';
                    timerStatus.classList.remove('waiting');
                    timerSection.style.background = 'linear-gradient(135deg, #007AFF 0%, #5856D6 100%)';
                } else {
                    timerStatus.textContent = '‚úÖ Siap! Ambil pakaian anda';
                    timerSection.style.background = 'linear-gradient(135deg, #34C759 0%, #30D158 100%)';
                }
            } else if (machine.status === 'reserved') {
                timerDisplay.textContent = '--:--';
                timerStatus.textContent = '‚è≥ Menunggu anda tekan START...';
                timerStatus.classList.add('waiting');
                timerSection.style.background = 'linear-gradient(135deg, #FF9500 0%, #FF3B30 100%)';
            } else if (machine.status === 'available') {
                timerDisplay.textContent = '‚úì';
                timerStatus.textContent = '‚úÖ Basuhan selesai!';
                timerSection.style.background = 'linear-gradient(135deg, #34C759 0%, #30D158 100%)';
            }
        });
    </script>
</body>
</html>
