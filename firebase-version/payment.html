<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bayar - Smart Dobi</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/payment.css">
</head>
<body>
    <!-- Back Button -->
    <a href="index.html" class="back-btn">
        ‚Üê Kembali
    </a>

    <div class="payment-wrapper">
        <div class="payment-card">
            <div class="payment-header">
                <div class="machine-icon">üß∫</div>
                <h1>Mesin <span id="machineNumber">1</span></h1>
                <p>Lengkapkan pembayaran untuk memulakan</p>
            </div>

            <!-- Amount -->
            <div class="amount-card">
                <span class="label">Jumlah Bayaran</span>
                <span class="value">RM 5.00</span>
            </div>

            <!-- QR Code -->
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=SmartDobi-Payment-Demo" 
                     alt="QR Code" 
                     style="border-radius: 12px; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <p style="margin-top: 0.5rem; font-size: 0.85rem; color: #8E8E93;">Scan QR untuk bayar</p>
            </div>

            <!-- WhatsApp Input -->
            <div class="input-section">
                <label class="input-label">üì± Nombor WhatsApp (Pilihan)</label>
                <input type="tel" id="whatsappInput" class="input-field" placeholder="60123456789" maxlength="12">
                <p class="input-hint">Masukkan untuk terima notifikasi bila siap</p>
            </div>

            <!-- Confirm Button -->
            <button id="confirmBtn" class="btn-confirm" onclick="confirmPayment()">
                ‚úì Sahkan Pembayaran
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-large"></div>
            <p style="color: white; font-size: 1.1rem;">Memproses...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, get, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBPaObgmHZBQR8-0aX3pTUOFeMOxIsn0Lc",
            authDomain: "smart-dobi-system-fyp.firebaseapp.com",
            databaseURL: "https://smart-dobi-system-fyp-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smart-dobi-system-fyp",
            storageBucket: "smart-dobi-system-fyp.firebasestorage.app",
            messagingSenderId: "377544234994",
            appId: "1:377544234994:web:690cd32c142e7ee501fd6b"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Get machine ID from URL
        const params = new URLSearchParams(window.location.search);
        const machineId = params.get('machine');

        if (!machineId) {
            alert('Ralat: Mesin tidak dipilih');
            window.location.href = 'index.html';
        } else {
            document.getElementById('machineNumber').textContent = machineId;
            
            // Verify machine is available
            const machineRef = ref(database, `machines/${machineId}`);
            get(machineRef).then((snapshot) => {
                if (!snapshot.exists()) {
                    alert('Mesin tidak dijumpai');
                    window.location.href = 'index.html';
                    return;
                }
                const machine = snapshot.val();
                if (machine.status !== 'available') {
                    alert('Mesin tidak tersedia. Sila pilih mesin lain.');
                    window.location.href = 'index.html';
                }
            });
        }

        // Confirm payment
        window.confirmPayment = async function() {
            let whatsapp = document.getElementById('whatsappInput').value.trim();
            
            // Format WhatsApp
            if (whatsapp) {
                whatsapp = whatsapp.replace(/\D/g, '');
                if (!whatsapp.startsWith('60')) {
                    whatsapp = '60' + whatsapp;
                }
            }

            // Show loading
            document.getElementById('loadingOverlay').style.display = 'flex';

            try {
                const machineRef = ref(database, `machines/${machineId}`);
                await update(machineRef, {
                    status: 'reserved',
                    whatsapp: whatsapp || null,
                    reserved_at: new Date().toISOString(),
                    time_remaining: 0
                });

                // Redirect to waiting page
                setTimeout(() => {
                    window.location.href = `waiting.html?machine=${machineId}`;
                }, 1000);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                alert('Ralat. Sila cuba lagi.');
            }
        }
    </script>
</body>
</html>
